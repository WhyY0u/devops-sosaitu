import{a as x,r as i,j as e,U as R}from"./index-3cPMuINo.js";import{C as I,a as E,T as C}from"./TicketList-DGwBJVjY.js";const T="_main_container_1v3qz_1",L="_name_1v3qz_5",M="_name_gradient_1v3qz_13",P="_ticket_status_1v3qz_19",j={main_container:T,name:L,name_gradient:M,ticket_status:P},U="_container_create_ticket_1e8lh_1",q="_plus_1e8lh_10",z="_title_container_1e8lh_25",A="_create_ticket_label_1e8lh_31",B="_label_1e8lh_37",D="_label_text_1e8lh_43",$="_input_1e8lh_50",F="_textarea_1e8lh_65",V="_button_1e8lh_82",G="_counter_1e8lh_113",s={container_create_ticket:U,plus:q,title_container:z,create_ticket_label:A,label:B,label_text:D,input:$,textarea:F,button:V,counter:G};class f{async getTickets(c,a){return(await x.get("/user/tickets",{params:{status:a?.status,sortBy:a?.sortBy}})).data}async createTicket(c,a){if(!c)throw new Error("User is required");return(await x.post("/user/createTicket",{name:a.title,description:a.description,cityId:a.cityId})).data}async getTicketById(c){throw new Error("Method not implemented.")}async updateTicket(c){throw new Error("Method not implemented.")}}class H{async getRegions(){return(await x.get("/location/regions")).data}async getCities(c){return(await x.get(`/location/regions/${c}/cities`)).data}async getAllCities(){return(await x.get("/location/cities")).data}}const J=({user:m,onTicketCreated:c})=>{const[a,d]=i.useState(""),[u,p]=i.useState(""),[w,h]=i.useState([]),[g,k]=i.useState(null),[y,t]=i.useState(!1),[r,l]=i.useState(null),[N,o]=i.useState(!1),b=i.useMemo(()=>new H,[]);i.useMemo(()=>new f,[]);const S=a.trim().length>0&&u.trim().length>0&&g!==null;i.useEffect(()=>{(async()=>{try{const _=await b.getCities(15);h(_)}catch(_){console.error("Не удалось загрузить города",_),h([])}})()},[b]);const v=async()=>{if(S){t(!0),l(null),o(!1);try{const _=await new f().createTicket(m,{title:a,description:u,cityId:g});o(!0),d(""),p(""),k(null),h([]),c&&_&&c(_)}catch(n){l(n.message||"Произошла ошибка при создании тикета")}finally{t(!1)}}};return e.jsxs("div",{className:s.container_create_ticket,children:[e.jsxs("div",{className:s.title_container,children:[e.jsx("p",{className:s.plus,children:"+"}),e.jsx("p",{className:s.create_ticket_label,children:"Создать новый тикет"})]}),e.jsxs("label",{className:s.label,children:[e.jsx("p",{className:s.label_text,children:"Тема обращения"}),e.jsx("input",{className:s.input,placeholder:"Опишите кратко суть вопроса...",maxLength:30,value:a,onChange:n=>d(n.target.value)}),e.jsxs("span",{className:s.counter,children:[a.length,"/30"]})]}),e.jsxs("label",{className:s.label,children:[e.jsx("p",{className:s.label_text,children:"Подробное описание"}),e.jsx("textarea",{className:s.textarea,placeholder:"Расскажите подробнее о вашем вопросе или проблеме...",maxLength:1e3,value:u,onChange:n=>p(n.target.value)}),e.jsxs("span",{className:s.counter,children:[u.length,"/1000"]})]}),e.jsxs("label",{className:s.label,children:[e.jsx("p",{className:s.label_text,children:"Города/районы"}),e.jsxs("select",{className:s.input,value:g??"",onChange:n=>k(n.target.value?Number(n.target.value):null),children:[e.jsx("option",{value:"",children:"Выберите город/район..."}),w.map(n=>e.jsx("option",{value:n.id,children:n.name},n.id))]})]}),r&&e.jsx("p",{className:s.error,children:r}),N&&e.jsx("p",{className:s.success,children:"Тикет успешно создан!"}),e.jsx("button",{className:s.button,disabled:!S||y,onClick:v,children:y?"Отправка...":"Отправить тикет"})]})},Q=()=>{const[m,c]=i.useState({all:0,new:0,inProgress:0,closed:0}),[a,d]=i.useState(null),[u,p]=i.useState([]),w=new f,h=new R;i.useEffect(()=>{(async()=>{const r=await h.getMe();d(r);const l=await w.getTickets(r,{sortBy:"date",status:"Все"});p(l.items);const N=l.items.reduce((o,b)=>{switch(b.status){case C.Expectation:o.new+=1;break;case C.InProgress:o.inProgress+=1;break;case C.Completed:o.closed+=1;break}return o.all+=1,o},{all:0,new:0,inProgress:0,closed:0});c(N)})()},[]);const g=t=>{console.log("Ticket created:",t);const r={ticket:{id:t.ticket.id,name:t.ticket.name,description:t.ticket.description,type:t.ticket.type,status:t.ticket.status,city:t.ticket.city,region:t.ticket.region,createdTime:t.ticket.createdTime,userId:t.ticket.userId,tags:t.ticket.tags||[],ai_comments:t.ticket.ai_comments||"",administratorResponse:t.ticket.administratorResponse||null},user:t.user};p(l=>[r,...l]),c(l=>({...l,all:l.all+1,new:l.new+1}))},k=localStorage.getItem("name")?.trim(),y=a?.fullName?.trim()||k||"...";return e.jsxs("div",{className:j.main_container,children:[e.jsxs("p",{className:j.name,children:["Добро пожаловать,",e.jsx("br",{}),e.jsxs("span",{className:j.name_gradient,children:[y,"!"]})]}),e.jsx("p",{className:j.ticket_status,children:"Создавайте тикеты и отслеживайте их статус"}),e.jsx(I,{counts:m}),a&&e.jsx(J,{user:a,onTicketCreated:g}),a&&e.jsx(E,{list:u,mode:"user"})]})};export{Q as default};
